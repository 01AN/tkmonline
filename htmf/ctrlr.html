<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ctrlr</title>
  <script src="Crunr.js"></script>
  <script src="ctrlr/Const.js"></script>
  <script src="ctrlr/Player.js"></script>
  <script src="ctrlr/GameService.js"></script>
  <script>
      var gs = null;
    
      Crunr.onLoad = function() {
        gs = new GameService();
        GameService.clear(gs);
        
        Crunr.observe('gs');
      }
      
      Crunr.onMessage = function(u, m) {
        var isUpdate, o;
        
        isUpdate = false;
        if(m[0] === 'g') {
          Crunr.send(u, JSON.stringify(gs));
        } if(gs.state === GameService.Ready) {
          switch(m[0]) {
            case 'a':
              o = GameService.splitOption(m);
              if(gs.players[o[0]].userid === '') {
                gs.players[o[0]].userid = u;
                isUpdate = true;
              }
            break;
            case 'b':
              o = GameService.splitOption(m);
              if(gs.players[o[0]].userid === u) {
                gs.players[o[0]].userid = '';
                isUpdate = true;
              }
            break;
            case 'c':
              if(gs.players[0].userid !== ''
              && gs.players[1].userid !== '') {
                GameService.start(gs);
                isUpdate = true;
              }
            break;
          }
        } else {
          switch(m[0]) {
            case 'd':
              if(gs.phase === Phase.Setup
              && gs.players[gs.active].userid === u
              ) {
                o = GameService.splitOption(m);
                gs.penguinMap[o[0]] = gs.active;
                gs.players[gs.active].penguin--;
                if(gs.active === 0) {
                  gs.active = 1;
                } else {
                  gs.active = 0;
                }
                if(gs.players[gs.active].penguin === 0) {
                  gs.phase = Phase.Hunting;
                }
                isUpdate = true;
              }
            break;
            case 'e':
              if(gs.phase === Phase.Hunting
              && gs.players[gs.active].userid === u
              ) {
                o = GameService.splitOption(m);
                gs.hunter = parseInt(o[0]);
                isUpdate = true;
              }
            break;
            case 'f':
              if(gs.phase === Phase.Hunting
              && gs.hunter !== -1
              && gs.players[gs.active].userid === u
              ) {
                o = GameService.splitOption(m);
                gs.players[gs.active].count++;
                gs.players[gs.active].score += gs.fishMap[gs.hunter];
                gs.fishMap[gs.hunter] = 0;
                gs.penguinMap[o[0]] = gs.penguinMap[gs.hunter];
                gs.penguinMap[gs.hunter] = -1;
                gs.hunter = -1;
                
                if(gs.active === 0) {
                  gs.active = 1;
                } else {
                  gs.active = 0;
                }
                
                if(!GameService.canMovePlayer(gs)) {
                  if(gs.active === 0) {
                    gs.active = 1;
                  } else {
                    gs.active = 0;
                  }
                  if(!GameService.canMovePlayer(gs)) {
                    if (gs.players[0].score > gs.players[1].score) {
                      Crunr.chat("おめでとうございます。" + gs.players[0].userid + "さん(青)の勝利です。");
                    } else if (gs.players[0].score < gs.players[1].score) {
                      Crunr.chat("おめでとうございます。" + gs.players[1].userid + "さん(黄)の勝利です。");
                    } else {
                      if(gs.players[0].count > gs.players[1].count) {
                        Crunr.chat("おめでとうございます。" + gs.players[0].userid + "さん(青)の勝利です。");
                      } else if(gs.players[0].count < gs.players[1].count) {
                        Crunr.chat("おめでとうございます。" + gs.players[1].userid + "さん(黄)の勝利です。");
                      } else {
                        Crunr.chat("結果は引き分けですが、素晴らしい試合でした。");
                      }
                    }
                    gs.state = GameService.Ready;
                    gs.players[0].userid = '';
                    gs.players[1].userid = '';
                  }
                }
                isUpdate = true;
              }
            break;
          }
        }
        if(isUpdate) {
          Crunr.broadcast(JSON.stringify(gs));
        }
      }
      
      Crunr.onChat = function(u, m) {
        switch (m) {
          case '/help':
            Crunr.chat('/dice ダイスを振る, /reset ゲームをリセットする');
          break;
          case '/dice':
            Crunr.chat(u + 'さんがダイスを振りました…「' + (Math.floor(Math.random() * 100) + 1) + '」');
          break;
          case '/reset':
            if(Crunr.ctrlrid === u) {
              Crunr.chat(u + 'さんがゲームをリセットしました');
              GameService.clear(gs);
              Crunr.broadcast(JSON.stringify(gs));
            } else {
              Crunr.chat(u + 'さんがゲームをリセットしようとしましたが、コントローラーでないため失敗しました。');
            }
          break;
        }
      }
    </script>
  </head>
  <body>
  </body>
</html>