<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>[3rd] バトルライソ</title>
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="../Runr.wsUrl.js"></script>
<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<script>
  var ctrlr, view;
  Runr.instance = 7;
  Runr.webSocket = null;
  Runr.watchList = [];
  Runr.userList = [];
  Runr.send = function(m) {
    Runr.webSocket.send(String.fromCharCode(Runr.instance) + m);
  }
  Runr.splitForSyntax1 = function(s) {
    return s.substring(1);
  }
  Runr.splitForSyntax2 = function(s) {
    var t = /^([^ ]*) ?(.*)$/.exec(s.substring(1));
    t.shift();
    return t;
  }
  Runr.splitForSyntax3 = function(s) {
    return (s.substring(1)).split(' ');
  }
  Runr.sendJson = function(s) {
    Runr.send('f' + s + ' ' + JSON.stringify(eval('ctrlr.' + s)));
  }
  Runr.repeet = function() {
    setTimeout(Runr.repeet, 5000)
  }
  Runr.repeet();
</script>
<style>
  body, div, p, ul, li, table, tr, td {
    margin: 0;
    padding: 0;
  }
  body {
    background-color: peachpuff;
    color: black;
    font-family: monospace;
    font-size: 14px;
  }
  ul {
    list-style: none;
  }
</style>
</head>

<body>
<div id="entry" style="width: 1000px; margin-left: auto; margin-right: auto; text-align: left;">
  
  <iframe id="ctrlr" src="ctrlr.html" style="display: none;"></iframe>
  
  <table id="login-panel">
    <tr>
      <td rowspan=4>
        <a href="http://tkmax.github.io/tkmonline/" target="_blank"><img id="mintitle" src="../title.png" width="140" height="100" /></a>
      </td>
    </tr>
    <tr>
      <td><input id="login" type="text" /></td>
    </tr>
    <tr>
      <td id="help"></td>
    </tr>
    <tr>
      <td id="user-list"></td>
    </tr>
  </table>
  
  <table id="play-panel" calign="center" style="display: none;">
    <tr>
      <td align=left valign=top>
        <ul>
          <li>
            <a href="http://tkmax.github.io/tkmonline/" target="_blank"><img id="mintitle" src="../title.png" width="140" height="100" /></a>
          </li>
          <li>あなた：</li>
          <li id="userid"></li>
          <li>コントローラー:</li>
          <li id="ctrlrid"></li>
          <li>
            <table>
              <tr>
                <td>
                  <input id="bell" type="button" value="ベル" style="width: 70px;"></input>
                </td>
              <tr>
              <tr>
                <td>
                  <input id="bell-switch" type="button" value="ベル音" style="width: 70px; background-color: orange;"></input>
                </td>
                <td>
                  <input id="chat-switch" type="button" value="チャット音" style="width: 70px; background-color: orange;"></input>
                </td>
              </tr>
            </table>
          </li>
          <li>
            <div id="user-list" style="background-color: lavender; color: black; overflow: scroll; width: 140px; height: 495px;">
            </div>
          </li>
        </ul>
      </td>
      <td >
        <ul>
          <li><iframe id="view" src="view.html" style="width: 860px; height: 540px;"></iframe></li>
          <li>
            <div id="chat-log" style="background-color: lavender; color: black; overflow: scroll; width: 865px; height: 150px;">
            </div>
          </li>
          <li><input id="chat" type="text" style="width: 860px;" /><li>
        </ul>
      </td>
    </tr>
  </table>  
</div>

<audio id="bell-se" preload="auto">
  <source src="bell.mp3" type="audio/mp3">
</audio>
<audio id="chat-se" preload="auto">
  <source src="chat.mp3" type="audio/mp3">
</audio>

<script>
  window.onload = function() {
    $('#bell-se')[0].volume = 0.2;
    $('#chat-se')[0].volume = 0.1;
    
    ctrlr = $('#ctrlr')[0].contentWindow;
    view = $('#view')[0].contentWindow;
    if(typeof WebSocket != 'undefined') {
      Runr.webSocket = new WebSocket(Runr.wsUrl);
    }
    if(Runr.webSocket) {
      Runr.webSocket.onopen = function() {
        Runr.send('a');
      }
      Runr.webSocket.onmessage = function(e) {
        var tmp, option, i;
        if(view.Vrunr.userid === '') {
          switch(e.data[0]) {
            case 'A':
              option = Runr.splitForSyntax3(e.data);
              tmp = '';
              for(i in option) {
                if(tmp !== '') {
                  tmp += '&nbsp;|&nbsp;';
                }
                tmp += option[i];
              }
              $('#login-panel #user-list').text('ログインユーザー&nbsp;:&nbsp;' + tmp);
            break;
            case 'B':
              $('#login-panel').hide();
              $('#play-panel').show();
              view.Vrunr.onLoad();
              view.Vrunr.userid = Runr.splitForSyntax1(e.data);
              $('#userid').text(view.Vrunr.userid);
              Runr.send('c');
            break;
            case 'C':
              $('#help').text('命名規則に違反するか、既に使用されているユーザー名です。ユーザー名はアルファベットと数字の１２文字以内を使用して下さい。');
            break;
          }
        } else {
          switch(e.data[0]) {
            case 'A':
              option = Runr.splitForSyntax3(e.data);
              Runr.userList = option;
            break;
            case 'D':
              option = Runr.splitForSyntax1(e.data);
              view.Vrunr.onAddUser(option);
              Runr.userList.push(option);
              $('#play-panel #user-list').text('');
              $('#play-panel #user-list').append('<ul>');
              for(i in Runr.userList) {
                $('#play-panel #user-list').append('<li>' + Runr.userList[i] + '</li>');
              }
              $('#play-panel #user-list').append('</ul>');
            break;
            case 'E':
              option = Runr.splitForSyntax1(e.data);
              view.Vrunr.onRemoveUser(option);
              i = 0;
              while(i < Runr.userList.length) {
                if(Runr.userList[i] === option) {
                  Runr.userList.splice(i, 1);
                } else {
                  i++;
                }
              }
              $('#play-panel #user-list').text('');
              $('#play-panel #user-list').append('<ul>');
              for(i in Runr.userList) {
                $('#play-panel #user-list').append('<li>' + Runr.userList[i] + '</li>');
              }
              $('#play-panel #user-list').append('</ul>');
            break;
            case 'F':
              option = Runr.splitForSyntax1(e.data);
              view.Vrunr.onBell(option);
              $('#chat-log').append('<p style="color: darkgreen;">' + option + 'さんが、ベルを鳴らしました。</p>');
              $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
              if($('#bell-switch').attr('value') !== 'OFF') {
                $('#bell-se')[0].play();
              }
            break;
            case 'G':
              option = Runr.splitForSyntax2(e.data);
              view.Vrunr.onChat(option[0], option[1]);
              if(option[0] === '@') {
                $('#chat-log').append('<p style="color: deeppink;">' + option[0] + (new Array((13 - option[0].length)).join('&nbsp;')) + '&nbsp;>>&nbsp;' + option[1] + '</p>');
              } else {
                $('#chat-log').append('<p>' + option[0] + (new Array((13 - option[0].length)).join('&nbsp;')) + '&nbsp;>>&nbsp;' + option[1] + '</p>');
              }
              $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
              if($('#chat-switch').attr('value') !== 'OFF') {
                $('#chat-se')[0].play();
              }
            break;
            case 'H':
              option = Runr.splitForSyntax2(e.data);
              eval('ctrlr.' + option[0] + '=JSON.parse(option[1])');
            break;
            case 'I':
              Runr.send('g');
            break;
            case 'J':
              option = Runr.splitForSyntax1(e.data);
              ctrlr.Crunr.ctrlrid = option;
              view.Vrunr.ctrlrid = option;
              view.Vrunr.onController(option);
              $('#ctrlrid').text(option);
            break;
            case 'K':
              Runr.send('h');
              tmp = Runr.splitForSyntax2(e.data);
              ctrlr.Crunr.onMessage(tmp[0], tmp[1]);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
            case 'L':
              tmp = Runr.splitForSyntax1(e.data);
              view.Vrunr.onMessage(tmp);
            break;
            case 'M':
              Runr.send('h');
              tmp = Runr.splitForSyntax1(e.data);
              ctrlr.Crunr.onController(tmp);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
            case 'N':
              Runr.send('h');
              tmp = Runr.splitForSyntax1(e.data);
              ctrlr.Crunr.onBell(tmp);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
            case 'O':
              Runr.send('h');
              tmp = Runr.splitForSyntax2(e.data);
              ctrlr.Crunr.onChat(tmp[0], tmp[1]);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
            case 'P':
              Runr.send('h');
              tmp = Runr.splitForSyntax1(e.data);
              ctrlr.Crunr.onAddUser(tmp);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
            case 'Q':
              Runr.send('h');
              tmp = Runr.splitForSyntax1(e.data);
              ctrlr.Crunr.onRemoveUser(tmp);
              for(i in Runr.watchList) {
                Runr.sendJson(Runr.watchList[i]);
              }
              Runr.send('i');
            break;
          }
        }
      }
      $('#login').keypress(function(e) {
        if(e.keyCode === 13) {
          Runr.send('b' + $(this).val());
        }
      });
      $('#bell').click(function() {
        Runr.send('d');
      });
      $('#bell-switch').click(function() {
        if($(this).attr('value') !== 'OFF') {
          $(this).attr('value','OFF').css('background-color','gray');
        } else {
          $(this).attr('value','ベル音').css('background-color','orange');
        }
      });
      $('#chat-switch').click(function() {
        if($(this).attr('value') !== 'OFF') {
          $(this).attr('value','OFF').css('background-color','gray');
        } else {
          $(this).attr('value','チャット音').css('background-color','orange');
        }
      });
      $('#chat').keypress(function(e) {
        if(e.keyCode === 13 && $(this).val() !== '') {
          Runr.send('e' + $(this).val());
          $(this).val('');
        }
      });
      $('#help').text('テキストボックスにアルファベットと数字の１２文字以内でユーザー名を入れてから、エンターキーを押して下さい。');
    } else {
      $('#help').text('WebSocketがサポートされていないブラウザです。');
    }
  }
</script>
</body>
</html>