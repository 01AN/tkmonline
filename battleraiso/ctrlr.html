<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ctrlr</title>
  <script src="Crunr.js"></script>
  <script src="ctrlr/Const.js"></script>
  <script src="ctrlr/Player.js"></script>
  <script src="ctrlr/GameService.js"></script>
  <script>
      var gs = null;
      
      Crunr.onLoad = function() {
        gs = new GameService();
        GameService.clear(gs);
        Crunr.observe('gs');
      }
      
      Crunr.onMessage = function(u, m) {
        var isUpdate, o, unActive;
        if(gs.active === 0) {
          unActive = 1;
        } else {
          unActive = 0;
        }
        isUpdate = false;
        if(m[0] === 't') {
          Crunr.unicast(u, JSON.stringify(gs));
        } if(gs.state === State.Ready) {
          switch(m[0]) {
            case 'a':
              o = GameService.splitOption(m);
              if(gs.players[o[0]].userid === '') {
                gs.players[o[0]].userid = u;
                isUpdate = true;
              }
            break;
            case 'b':
              o = GameService.splitOption(m);
              if(gs.players[o[0]].userid === u) {
                gs.players[o[0]].userid = '';
                isUpdate = true;
              }
            break;
            case 'c':
              if(gs.players[0].userid !== ''
              && gs.players[1].userid !== '') {
                Crunr.bell();
                GameService.start(gs);
                isUpdate = true;
              }
            break;
          }
        } else {
          switch(m[0]) {
            case 'd':
              if(gs.phase === Phase.Main) {
                o = GameService.splitOption(m);
                Crunr.chat((parseInt(o[0]) + 1) + '列目の旗を獲得しました。');
                gs.flags[o[0]] = gs.active;
                if(GameService.isWin(gs)) {
                  Crunr.bell();
                  if(gs.active === 0) {
                    Crunr.chat("おめでとうございます。" + gs.players[0].userid + "さん(青)の勝利です。");
                  } else {
                    Crunr.chat("おめでとうございます。" + gs.players[1].userid + "さん(黄)の勝利です。");
                  }
                  gs.players[0].userid = '';
                  gs.players[1].userid = '';
                  gs.state = State.Ready;
                }
                isUpdate = true;
              }
            break;
            case 'e':
              if(gs.phase === Phase.Main
              || gs.phase === Phase.Unit
              || gs.phase === Phase.Fog
              || gs.phase === Phase.Mud
              || gs.phase === Phase.Scout1
              || gs.phase === Phase.Redeploy1
              || gs.phase === Phase.Deserter
              || gs.phase === Phase.Traitor1
              ) {
                o = GameService.splitOption(m);
                gs.play = parseInt(o[0]);
                switch(gs.players[gs.active].hand[gs.play]) {
                  case Tactics.Fog:
                    gs.phase = Phase.Fog;
                  break;
                  case Tactics.Mud:
                    gs.phase = Phase.Mud;
                  break;
                  case Tactics.Scout:
                    gs.phase = Phase.Scout1;
                  break;
                  case Tactics.Redeploy:
                    gs.phase = Phase.Redeploy1;
                  break;
                  case Tactics.Deserter:
                    gs.phase = Phase.Deserter;
                  break;
                  case Tactics.Traitor:
                    gs.phase = Phase.Traitor1;
                  break;
                  default:
                    gs.phase = Phase.Unit;
                  break;
                }
                isUpdate = true;
              }
            break;
            case 'f':
              if(gs.phase === Phase.Unit) {
                o = GameService.splitOption(m);
                gs.players[gs.active].field[o[0]].push(gs.players[gs.active].hand[gs.play]);
                gs.before.idx = gs.active;
                gs.before.x = gs.players[gs.active].field[o[0]].length - 1;
                gs.before.y = parseInt(o[0]);
                if((gs.players[gs.active].hand[gs.play] & 0xff00) !== 0x0600) {
                  gs.stock[
                    ((gs.players[gs.active].hand[gs.play] & 0xff00) >> 8) * 10 + (gs.players[gs.active].hand[gs.play] & 0x00ff)
                  ] = -1;
                } else {
                  gs.players[gs.active].count++;
                  if(gs.players[gs.active].hand[gs.play] === Tactics.Alexander
                  || gs.players[gs.active].hand[gs.play] === Tactics.Darius
                  ) {
                    gs.players[gs.active].leader++;
                  }
                }
                gs.players[gs.active].hand.splice(gs.play, 1);
                gs.play = -1;
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                isUpdate = true;
              }
            break;
            case 'g':
              if(gs.phase === Phase.Fog) {
                Crunr.chat('霧をプレイしました。');
                gs.players[gs.active].count++;
                o = GameService.splitOption(m);
                gs.weather[o] += 1;
                gs.players[gs.active].hand.splice(gs.play, 1);
                gs.play = -1;
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                gs.before.idx = gs.before.x = gs.before.y = - 1;
                isUpdate = true;
              }
            break;
            case 'h':
              if(gs.phase === Phase.Mud) {
                Crunr.chat('泥をプレイしました。');
                gs.players[gs.active].count++;
                o = GameService.splitOption(m);
                gs.weather[o] += 2;
                gs.size[o] = 4;
                gs.players[gs.active].hand.splice(gs.play, 1);
                gs.play = -1;
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                gs.before.idx = gs.before.x = gs.before.y = - 1;
                isUpdate = true;
              }
            break;
            case 'i':
              if((gs.phase === Phase.Scout1
                || gs.phase === Phase.Scout2
                )
              && gs.unitDeck.length > 0
              ) {
                if(gs.phase === Phase.Scout1) {
                  Crunr.chat('偵察をプレイしました。');
                  gs.players[gs.active].count++;
                  GameService.discard(gs);
                  gs.phase = Phase.Scout2;
                }
                Crunr.chat('部隊カードを１枚引きました。');
                gs.players[gs.active].hand.push(gs.unitDeck.shift());
                if(gs.players[gs.active].hand.length >= 9
                || (
                  gs.unitDeck.length === 0
                  && gs.tacticsDeck.length === 0
                )) {
                  gs.phase = Phase.Scout3;
                  if(gs.players[gs.active].hand.length <= 7) {
                    GameService.nextTurn(gs);
                  }
                }
                isUpdate = true;
              }
            break;
            case 'j':
              if((gs.phase === Phase.Scout1
                || gs.phase === Phase.Scout2
                )
              && gs.tacticsDeck.length > 0
              ) {
                if(gs.phase === Phase.Scout1) {
                  Crunr.chat('偵察をプレイしました。');
                  gs.players[gs.active].count++;
                  GameService.discard(gs);
                  gs.phase = Phase.Scout2;
                }
                Crunr.chat('戦術カードを１枚引きました。');
                gs.players[gs.active].hand.push(gs.tacticsDeck.shift());
                if(gs.players[gs.active].hand.length >= 9
                || (
                  gs.unitDeck.length === 0
                  && gs.tacticsDeck.length === 0
                )) {
                  gs.phase = Phase.Scout3;
                  if(gs.players[gs.active].hand.length <= 7) {
                    GameService.nextTurn(gs);
                  }
                }
                isUpdate = true;
              }
            break;
            case 'k':
              o = GameService.splitOption(m);
              if(gs.phase === Phase.Scout3
              && gs.players[gs.active].hand.length > 7
              && gs.players[gs.active].hand.length > parseInt(o)
              ) {
                if((gs.players[gs.active].hand[o] & 0xff00) === 0x0600) {
                  Crunr.chat('戦術カードを１枚山札の一番上に置きました。');
                  gs.tacticsDeck.unshift(gs.players[gs.active].hand[o]);
                } else {
                  Crunr.chat('部隊カードを１枚山札の一番上に置きました。');
                  gs.unitDeck.unshift(gs.players[gs.active].hand[o]);
                }
                gs.players[gs.active].hand.splice(o, 1);
                if(gs.players[gs.active].hand.length <= 7) {
                  gs.before.idx = gs.before.x = gs.before.y = - 1;
                  GameService.nextTurn(gs);
                }
                isUpdate = true;
              }
            break;
            case 'l':
              if(gs.phase === Phase.Redeploy1) {
                Crunr.chat('再配置をプレイしました。');
                gs.players[gs.active].count++;
                o = GameService.splitOption(m);
                gs.target.y = parseInt(o[0]);
                gs.target.x = parseInt(o[1]);
                gs.phase = Phase.Redeploy2;
                isUpdate = true;
              }
            break;
            case 'm':
              if(gs.phase === Phase.Redeploy2) {
                o = GameService.splitOption(m);
                if(o[0] === '-1') {
                  Crunr.chat((gs.target.y + 1)+ '列目から除外しました。');
                  gs.players[gs.active].talon.push(
                    gs.players[gs.active].field[gs.target.y][gs.target.x]
                  );
                  gs.players[gs.active].field[gs.target.y].splice(gs.target.x, 1);
                  gs.before.idx = gs.before.x = gs.before.y = - 1;
                } else {
                  gs.players[gs.active].field[o[0]].push(
                    gs.players[gs.active].field[gs.target.y][gs.target.x]
                  );
                  gs.players[gs.active].field[gs.target.y].splice(gs.target.x, 1);
                  gs.before.idx = gs.active;
                  gs.before.x = gs.players[gs.active].field[o[0]].length - 1;
                  gs.before.y = parseInt(o[0]);
                }
                gs.target.y = -1;
                gs.target.x = -1;
                GameService.discard(gs);
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                isUpdate = true;
              }
            break;
            case 'n':
              if(gs.phase === Phase.Deserter) {
                Crunr.chat('脱走をプレイしました。');
                gs.players[gs.active].count++;
                o = GameService.splitOption(m);
                Crunr.chat((parseInt(o[0]) + 1)+ '列目から除外しました。');
                gs.players[unActive].talon.push(
                  gs.players[unActive].field[o[0]][o[1]]
                );
                gs.players[unActive].field[o[0]].splice(o[1], 1);
                gs.before.idx = gs.before.x = gs.before.y = - 1;
                GameService.discard(gs);
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                isUpdate = true;
              }
            break;
            case 'o':
              if(gs.phase === Phase.Traitor1) {
                Crunr.chat('裏切りをプレイしました。');
                gs.players[gs.active].count++;
                o = GameService.splitOption(m);
                gs.target.y = parseInt(o[0]);
                gs.target.x = parseInt(o[1]);
                gs.phase = Phase.Traitor2;
                isUpdate = true;
              }
            break;
            case 'p':
              if(gs.phase === Phase.Traitor2) {
                o = GameService.splitOption(m);
                gs.players[gs.active].field[o[0]].push(
                  gs.players[unActive].field[gs.target.y][gs.target.x]
                );
                gs.before.idx = gs.active;
                gs.before.x = gs.players[gs.active].field[o[0]].length - 1;
                gs.before.y = parseInt(o[0]);
                gs.players[unActive].field[gs.target.y].splice(gs.target.x, 1);
                gs.target.y = -1;
                gs.target.x = -1;
                GameService.discard(gs);
                if(gs.unitDeck.length > 0 || gs.tacticsDeck.length > 0) {
                  gs.phase = Phase.Draw;
                } else {
                  GameService.nextTurn(gs);
                }
                isUpdate = true;
              }
            break;
            case 'q':
              if(gs.phase === Phase.Draw) {
                gs.players[gs.active].hand.push(gs.unitDeck.shift());
                GameService.nextTurn(gs);
                isUpdate = true;
              }
            break;
            case 'r':
              if(gs.phase === Phase.Draw) {
                gs.players[gs.active].hand.push(gs.tacticsDeck.shift());
                GameService.nextTurn(gs);
                isUpdate = true;
              }
            break;
            case 's':
              if(gs.phase === Phase.Main) {
                Crunr.chat('パスしました。');
                GameService.nextTurn(gs);
                isUpdate = true;
              }
            break;
          }
        }
        if(isUpdate) {
          Crunr.broadcast(JSON.stringify(gs));
        }
      }
      
      Crunr.onChat = function(u, m) {
        switch (m) {
          case '/help':
            Crunr.chat('/dice ダイスを振る, /reset ゲームをリセットする');
          break;
          case '/dice':
            Crunr.chat(u + 'さんがダイスを振りました…「' + (Math.floor(Math.random() * 100) + 1) + '」');
          break;
          case '/reset':
            if(Crunr.ctrlrid === u) {
              Crunr.chat(u + 'さんがゲームをリセットしました');
              GameService.clear(gs);
              Crunr.broadcast(JSON.stringify(gs));
            } else {
              Crunr.chat(u + 'さんがゲームをリセットしようとしましたが、コントローラーでないため失敗しました。');
            }
          break;
        }
      }
    </script>
  </head>
  <body>
  </body>
</html>