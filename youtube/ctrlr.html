<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ctrlr</title>
<script src="Crunr.js"></script>
<script>
  var service = null;
  
  Crunr.onLoad = function() {
    service = {};
    service.currentVideo = null;
    service.currentVideoStart = null;
    service.idCount = 0;
    service.list = [];
    Crunr.observe('service');
  }
    
  Crunr.onMessage = function(u, m) {
    var array = m.split(' '), now, offset, data, id, idx, i, foo, bar;
    
    switch(array[0]) {
      case 'enter':
        Crunr.send(u, 'list ' + JSON.stringify(service.list));
        
        if(service.currentVideo !== null) {
          now = new Date().getTime();
          offset = Math.floor((now - service.currentVideoStart) / 1000);
          if (offset < service.currentVideo.duration) {
            Crunr.send(u, 'play ' + service.currentVideo.id + ' ' + offset + ' ' + service.currentVideoStart);
          }
        }
      break;
      case 'add':
        data = eval('(' + m.substring(4) + ')');
        data.id = service.idCount;
        service.idCount++;
        service.list.push(data);
        Crunr.broadcast('list ' + JSON.stringify(service.list));
      break;
      case 'remove':
        id = parseInt(array[1]);
        idx = null;
        for(i in service.list) {
          if(id === service.list[i].id) {
            idx = i;
            break;
          }
        }
        if(idx === null) {
          return;
        }
        service.list.splice(idx, 1);
        Crunr.broadcast('list ' + JSON.stringify(service.list));
      break;
      case 'play':
        id = parseInt(array[1]);
        idx = null;
        for(i in service.list) {
          if(service.list[i].id === id) {
            idx = i;
            break;
          }
        }
        if(idx === null) {
          return;
        }
        
        service.currentVideo = service.list[idx];
        service.currentVideoStart = new Date().getTime();
        Crunr.broadcast('play ' + service.currentVideo.id + ' ' + 0 + ' ' + service.currentVideoStart);
      break;
      case 'next':
        for(i = 0; i < service.list.length; i++) {
          if(service.list[i].id === service.currentVideo.id) {
            idx = i;
            break;
          }
        }
        if(idx === null) {
          return;
        }
        
        nextIdx = (idx + 1) % service.list.length;
        service.currentVideo = service.list[nextIdx];
        service.currentVideoStart = new Date().getTime();
        Crunr.broadcast('play ' + service.currentVideo.id + ' ' + 0 + ' ' + service.currentVideoStart);
      break;
      case 'list':
        foo = array[1].split(',');
        bar = [];
        for(i in foo) {
          bar.push(getVideoobj(parseInt(foo[i])));
        }
        service.list = bar;
        Crunr.broadcast('list ' + JSON.stringify(service.list));
      break;
    }
  }
  
  var getVideoobj = function(id) {
    var i;
    
    for(i in service.list) {
      if(service.list[i].id === id) {
        return service.list[i];
      }
    }
    return null;
  }
</script>
</head>
<body>
</body>
</html>