<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>view</title>
    <script src="../view.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script>
        var list = [], currentVideo = null, currentVideoStart = null, timeoutId = null;

        var search = function (keyword) {
            var query, jsonpURL, script, head;

            $('#search-result').html('loading..');
            query = encodeURIComponent(keyword);
            jsonpURL = "http://gdata.youtube.com/feeds/videos?vq=" + query + "&max-results=20&alt=json-in-script&callback=listVideos";

            script = document.createElement('script');
            script.src = jsonpURL;
            head = document.getElementsByTagName('head')[0];
            head.appendChild(script);
        }

        var listVideos = function (data) {
            var entries, i;

            $('#search-result').empty();

            if (data.feed.openSearch$totalResults.$t > 0) {
                entries = data.feed.entry;
                for (i in entries) {
                    (function (entry) {
                        var videoid, title, duration, str;

                        if (entry['yt$noembed']) {
                            return;
                        }

                        videoid = entry.id.$t.split('/').pop();
                        title = entry.title.$t;
                        duration = entry['media$group']['yt$duration'].seconds;

                        str = '';
                        str += '<div style="display: block; float: left; background-color: #000000; margin: 5px; width: 130px; height: 140px;">';
                        str += '<div id="result-video-' + i + '" style="width: 130px; height: 100px; background-color: #000000;">';
                        str += '<img src="http://i.ytimg.com/vi/' + videoid + '/1.jpg">';
                        str += '</div>';
                        str += '<div style="font-size: 10px; background-color: #000000; color: #ffffff;">' + title + '</div>';
                        str += '<div style="font-size: 10px; background-color: #000000; color: #ffffff;">' + duration + '</div>';
                        str += '</div>';

                        $('#search-result').append(str);

                        $('#result-video-' + i).click(function () {
                            var data = {};
                            data.videoid = videoid;
                            data.title = title;
                            data.duration = parseInt(duration);
                            send('b ' + JSON.stringify(data));
                        });
                    })(entries[i]);
                }
            } else {
                $('#search-result').append('<p>not found</p>');
            }
        }

        onLoad = function () {
            $('#menu a[href=#tab1]').click(function (event) {
                $('#video-container').animate({
                    width: '848px',
                    height: '477px'
                }, 100);
                $('#panels div[id^=panel]').hide();
                $('#panel1').fadeIn();
                event.preventDefault();
            });
            $('#menu a[href=#tab2]').click(function (event) {
                $('#video-container').animate({
                    width: '200px',
                    height: '150px'
                }, 100);
                $('#panels div[id^=panel]').hide();
                $('#panel2').fadeIn();
                event.preventDefault();
            });
            $('#menu a[href=#tab3]').click(function (event) {
                $('#video-container').animate({
                    width: '200px',
                    height: '150px'
                }, 100);
                $('#panels div[id^=panel]').hide();
                $('#panel3').fadeIn();
                event.preventDefault();
            });
            $('#search-text').keypress(function (e) {
                var line;
                if (e.keyCode === 13) {
                    line = $('#search-text').val();
                    $('#search-text').val('');
                    search(line);
                }
            });
            $('#video-container').animate({
                width: '848px',
                height: '477px'
            }, 100);
            $('#panels div[id^=panel]').hide();
            $('#panel1').fadeIn();
            send('a');
        }

        onMessage = function (msg) {
            var tmp = msg.split(' '), i, video, str, playerHtml;

            if (tmp[0] === 'A') {
                list = JSON.parse(msg.substring(2));
                $('#video-list').empty();
                for (i in list) {
                    video = list[i];
                    str = '';
                    str += '<li id="aid' + video.id + '" style="display: block; float: left; background-color: #f8f8f8; margin: 5px; width: 130px; height: 140px;">';
                    str += '<div id="tid' + i + '" style="width: 130px; height: 100px; background-color: #000000;">';
                    str += '<img src="http://i.ytimg.com/vi/' + video.videoid + '/1.jpg">';
                    str += '</div>';
                    str += '<div style="font-size: 10px; background-color: #f8f8f8; color: #808080;">' + video.title + '</div>';
                    str += '<div style="font-size: 10px; background-color: #f8f8f8; color: #808080;">' + video.duration + '</div>';
                    str += '<div id="delete-video-' + i + '" style="float: right; font-size: 14px; background-color: #f8f8f8; color: #808080;">×</div>';
                    str += '</li>';
                    $('#video-list').append(str);
                    $('#tid' + i).data('id', video.id);
                    $('#tid' + i).data('videoid', video.videoid);
                    $('#tid' + i).click(function () {
                        send('d ' + $(this).data('id'));
                    });
                    $('#delete-video-' + i).data('id', video.id);
                    $('#delete-video-' + i).click(function () {
                        send('c ' + $(this).data('id'));
                    });
                    $('#video-list').sortable({
                        cursor: 'pointer',
                        start: function (event, ui) {
                            $('#video-list').data('org', $('#video-list').sortable('toArray'));
                        },
                        stop: function () {
                            var ary, ary2, i, id;
                            ary = $('#video-list').sortable('toArray');
                            ary2 = [];
                            for (i in ary) {
                                id = parseInt(ary[i].substring(3));
                                ary2[i] = id;
                            }
                            if ($('#video-list').data('org').join('') !== ary.join('')) {
                                send('e ' + JSON.stringify(ary2));
                            }
                        }
                    });
                }
            } else if (tmp[0] === 'B') {
                var id = parseInt(tmp[1]), offset = tmp[2], video = null;
                for (i in list) {
                    if (list[i].id === id) {
                        video = list[i];
                    }
                }
                if (video === null) return;
                if (timeoutId !== null) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
                currentVideo = video;
                currentVideoStart = parseInt(tmp[3]);

                playerHtml = '<object width="848" height="477"><param name="movie" value="http://www.youtube.com/v/' + video.videoid + '?version=3&amp;hl=ja_JP&amp;autoplay=1&start=' + offset + '"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><param name="wmode" value="opaque"></param><embed src="http://www.youtube.com/v/' + video.videoid + '?version=3&amp;hl=ja_JP&amp;autoplay=1&start=' + offset + '" type="application/x-shockwave-flash" width="848" height="477" allowscriptaccess="always" allowfullscreen="true" wmode="opaque"></embed></object>';
                $('#video-container').html(playerHtml);
            }
        }
    </script>
    <style>
        #menu ul {
            list-style: none;
            margin: 0px;
            padding: 0px;
        }
        #menu ul li {
            float: left;
            margin: 0px;
            padding: 0px;
            width: 140px;
            height: 40px;
        }
        #menu a {
            display: block;
            margin: 5px;
            border: 1px solid #ccc;
            padding: 5px;
            text-decoration: none;
            background-color: #404080;
            color: #ffffff;
            text-align: center;
        }
        #menu a:hover {
            background-color: #8080ff;
        }
        #video-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        #video-list li {
            margin: 1px;
            float: left;
            width: 130px;
            height: 97px;
        }
        #video-container {
            margin: 0;
            padding: 0;
            position: relative;
            overflow: no-display;
        }
        #video-container iframe, #video-container object, #video-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="video-container"></div>

    <div id="menu">
        <ul>
            <li><a href="#tab1">動画プレイヤー</a></li>
            <li><a href="#tab2">再生リスト</a></li>
            <li><a href="#tab3">検索</a></li>
        </ul>
    </div>

    <div style="clear: both;"></div>

    <div id="panels">
        <div id="panel1" style="display: block;">
            <div id="theater" style="display: block;"></div>
        </div>
        <div id="panel2" style="display: block;">
            <div id="video-list" style="display: block;"></div>
        </div>
        <div id="panel3" style="display: none;">
            <div id="search" style="display: block;">
                <div>キーワード&nbsp;:&nbsp;<input id="search-text" type="text"></div>
                <div id="search-result"></div>
            </div>
        </div>
    </div>
</body>
</html>